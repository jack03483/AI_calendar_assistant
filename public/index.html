<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2026 Calendar</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#02040a;
      --bg1:#030816;
      --panel: rgba(6, 10, 22, .78);
      --panel2: rgba(6, 10, 22, .56);
      --border: rgba(51, 199, 255, .26);
      --border2: rgba(51, 199, 255, .18);
      --text: rgba(103, 232, 255, .95);
      --text2: rgba(51, 199, 255, .95);
      --muted: rgba(103, 232, 255, .78);
      --shadow: 0 14px 52px rgba(0,0,0,.62);
      --glow: 0 0 22px rgba(51,199,255,.16), 0 0 52px rgba(51,199,255,.10);
      --radius: 18px;
      --dangerBorder: rgba(255, 80, 120, .28);
    }

    * { box-sizing: border-box; }
    html, body{ height:100%; overflow:hidden; }

    body{
      margin:0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-size: 16px;
      background:
        radial-gradient(1000px 720px at 50% 10%, rgba(51,199,255,.105), transparent 62%),
        radial-gradient(1000px 720px at 50% 90%, rgba(51,199,255,.105), transparent 62%),
        radial-gradient(900px 650px at 50% 50%, rgba(103,232,255,.070), transparent 68%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      padding: 16px;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(rgba(51,199,255,.055) 1px, transparent 1px),
        linear-gradient(90deg, rgba(51,199,255,.055) 1px, transparent 1px);
      background-size: 72px 72px, 72px 72px;
      opacity:.34;
      mix-blend-mode: screen;
    }

    .wrap{
      width: min(1120px, calc(100% - 0px));
      height: calc(100vh - 32px);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      z-index: 2;
      overflow:hidden;
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid rgba(51, 199, 255, .26);
      border-radius: var(--radius);
      box-shadow: 0 14px 52px rgba(0,0,0,.62), var(--glow);
      padding: 18px;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      display:flex;
      flex-direction:column;
      gap: 14px;
      flex: 1 1 auto;
      min-height: 0;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: var(--radius);
      box-shadow: 0 0 0 1px rgba(51,199,255,.12) inset;
      pointer-events:none;
    }

    .topRow{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    .title{
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .2px;
      color: rgba(192,247,255,.94);
      user-select:none;
    }
    .rightRow{
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      border: 1px solid rgba(103,232,255,.48);
      background: linear-gradient(180deg, rgba(51,199,255,.20), rgba(51,199,255,.08));
      color: rgba(51,199,255,.95);
      padding: 12px 16px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing: .22px;
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 26px rgba(51,199,255,.14),
        0 0 44px rgba(51,199,255,.08);
      transition: transform .12s, box-shadow .12s, border-color .12s, filter .12s;
      user-select:none;
      font-size: 14px;
      filter: saturate(1.05);
    }
    button:hover{
      transform: translateY(-1px);
      border-color: rgba(103,232,255,.75);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 34px rgba(51,199,255,.18),
        0 0 58px rgba(51,199,255,.11);
      filter: saturate(1.18) brightness(1.03);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btnSubtle{
      padding: 11px 14px;
      font-size: 13px;
      font-weight: 850;
      opacity: .94;
      background: rgba(2,6,23,.62);
      border-color: rgba(103,232,255,.22);
      box-shadow: 0 0 0 1px rgba(0,0,0,.38) inset, 0 0 18px rgba(51,199,255,.08);
      color: rgba(192,247,255,.92);
    }
    .btnDanger{
      border: 1px solid var(--dangerBorder);
      background: linear-gradient(180deg, rgba(255,80,120,.18), rgba(255,80,120,.08));
      color: rgba(255, 200, 220, .98);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 26px rgba(255,80,120,.10),
        0 0 44px rgba(255,80,120,.06);
    }
    .btnDanger:hover{
      border-color: rgba(255,80,120,.55);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 34px rgba(255,80,120,.13),
        0 0 58px rgba(255,80,120,.08);
      filter: saturate(1.10) brightness(1.02);
    }

    .monthbar{
      display:grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 10px;
      position: relative;
      z-index: 1;
    }
    .mbtn{
      padding: 11px 0;
      font-size: 13px;
      border-radius: 999px;
      min-width: 0;
      text-align:center;
      background: rgba(2,6,23,.62);
      border-color: rgba(103,232,255,.22);
      color: rgba(192,247,255,.92);
      box-shadow: 0 0 0 1px rgba(0,0,0,.38) inset, 0 0 18px rgba(51,199,255,.08);
    }
    .mbtn.active{
      background: linear-gradient(180deg, rgba(51,199,255,.26), rgba(51,199,255,.10));
      border-color: rgba(103,232,255,.58);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 30px rgba(51,199,255,.16),
        0 0 56px rgba(51,199,255,.10);
    }

    .calendar{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .monthTitle{
      margin: 0;
      font-size: 16px;
      letter-spacing: .3px;
      color: rgba(192,247,255,.94);
      text-align: left;
      user-select:none;
    }

    .dow, .grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
    }
    .dow div{
      font-size: 12px;
      color: rgba(103,232,255,.78);
      text-align:center;
      user-select:none;
      padding: 2px 0;
    }

    .grid{
      flex: 1 1 auto;
      min-height: 0;
      align-content: stretch;
    }

    .day{
      border-radius: 18px;
      border: 1px solid rgba(51,199,255,.18);
      background: linear-gradient(180deg, rgba(2,6,23,.74), rgba(2,6,23,.46));
      box-shadow: 0 0 0 1px rgba(0,0,0,.38) inset, 0 0 18px rgba(51,199,255,.08);
      padding: var(--dayPad, 10px);
      min-height: var(--dayMinH, 86px);
      display:flex;
      flex-direction:column;
      gap: var(--dayGap, 8px);
      min-width: 0;
      overflow: hidden;
      cursor: pointer;
    }
    .day.muted{
      opacity: .55;
      border-style: dashed;
      background: rgba(2,6,23,.35);
      cursor: default;
    }
    .num{
      font-size: var(--numSize, 12px);
      color: rgba(192,247,255,.84);
      user-select:none;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }

    .event{
      font-size: var(--eventSize, 12px);
      padding: var(--eventPadY, 6px) var(--eventPadX, 10px);
      border-radius: 999px;
      border: 1px solid rgba(103,232,255,.22);
      background: rgba(51,199,255,.10);
      color: rgba(192,247,255,.94);
      box-shadow: 0 0 0 1px rgba(0,0,0,.35) inset, 0 0 16px rgba(51,199,255,.08);
      cursor: pointer;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;

      transition: transform .10s ease, border-color .12s ease, filter .12s ease;
    }
    .event:hover{
      transform: translateY(-1px);
      border-color: rgba(103,232,255,.55);
      filter: brightness(1.03) saturate(1.08);
    }
    .event.more{
      background: rgba(2,6,23,.55);
      color: rgba(103,232,255,.82);
    }

    .composer{
      border-top: 1px solid rgba(51,199,255,.16);
      padding-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    textarea{
      width: 100%;
      color: rgba(51,199,255,.95);
      background: rgba(2,6,23,.60);
      border: 1px solid rgba(51,199,255,.18);
      border-radius: 14px;
      padding: 14px 16px;
      outline: none;
      font-size: 15px;
      line-height: 1.55;
      letter-spacing: .1px;
      caret-color: rgba(103,232,255,.95);
      transition: box-shadow .18s, border-color .18s, transform .18s;
      resize: none;
      height: 86px;
    }
    textarea:focus{
      border-color: rgba(103,232,255,.58);
      box-shadow: 0 0 0 3px rgba(51,199,255,.14), 0 0 26px rgba(51,199,255,.18);
      transform: translateY(-1px);
    }

    .drop{
      border: 1px solid rgba(51,199,255,.22);
      background: rgba(2,6,23,.55);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.38) inset, 0 0 18px rgba(51,199,255,.08);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    input[type="file"]{ display:none; }

    .thumbs{ display:flex; flex-wrap:wrap; gap: 10px; }
    .thumb{
      width: 76px; height: 76px;
      border-radius: 18px;
      border: 1px solid rgba(51,199,255,.18);
      background: rgba(2,6,23,.60);
      box-shadow: 0 0 0 1px rgba(0,0,0,.38) inset, 0 0 18px rgba(51,199,255,.08);
      object-fit: cover;
    }

    .status{
      font-size: 13px;
      color: rgba(103,232,255,.82);
      line-height: 1.35;
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select:none;
    }

    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 16px;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width: min(720px, 100%);
      background: linear-gradient(180deg, rgba(6,10,22,.92), rgba(6,10,22,.72));
      border: 1px solid rgba(51,199,255,.26);
      border-radius: 18px;
      box-shadow: 0 14px 52px rgba(0,0,0,.62), var(--glow);
      padding: 16px;
      backdrop-filter: blur(10px);
      position: relative;
      overflow:hidden;
    }
    .modal::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 18px;
      box-shadow: 0 0 0 1px rgba(51,199,255,.12) inset;
      pointer-events:none;
    }
    .modalTop{
      display:flex;
      gap: 12px;
      justify-content:space-between;
      align-items:flex-start;
      position: relative;
      z-index: 1;
    }
    .modalTitle{
      margin: 0;
      font-size: 16px;
      color: rgba(192,247,255,.94);
      letter-spacing: .25px;
    }
    .modalMeta{
      color: rgba(103,232,255,.78);
      font-size: 13px;
      margin-top: 6px;
      font-variant-numeric: tabular-nums;
    }

    .modalBody{
      position: relative;
      z-index: 1;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(51,199,255,.14);
      color: rgba(192,247,255,.90);
      font-family: "Source Serif 4", ui-serif, Georgia, "Times New Roman", serif;
      font-size: 18px;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: min(60vh, 520px);
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(103,232,255,.55) rgba(2,6,23,.30);
    }
    .modalBody::-webkit-scrollbar { width: 10px; }
    .modalBody::-webkit-scrollbar-track { background: rgba(2,6,23,.30); border-radius: 10px; }
    .modalBody::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(103,232,255,.65), rgba(51,199,255,.45));
      border-radius: 10px;
    }

    .modalForm{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      position: relative;
      z-index: 1;
    }
    .modalInput{
      width: 100%;
      color: rgba(51,199,255,.95);
      background: rgba(2,6,23,.60);
      border: 1px solid rgba(51,199,255,.18);
      border-radius: 14px;
      padding: 12px 14px;
      outline: none;
      font-size: 15px;
      line-height: 1.35;
      caret-color: rgba(103,232,255,.95);
    }
    .modalInput:focus{
      border-color: rgba(103,232,255,.58);
      box-shadow: 0 0 0 3px rgba(51,199,255,.14), 0 0 26px rgba(51,199,255,.18);
    }
    .modalText{
      height: 180px;
      resize: none;
      font-family: "Source Serif 4", ui-serif, Georgia, "Times New Roman", serif;
      font-size: 18px;
      line-height: 1.6;
    }

    .dangerBtn{
      border: 1px solid var(--dangerBorder);
      background: linear-gradient(180deg, rgba(255,80,120,.18), rgba(255,80,120,.08));
      color: rgba(255, 200, 220, .98);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 26px rgba(255,80,120,.10),
        0 0 44px rgba(255,80,120,.06);
    }
    .dangerBtn:hover{
      border-color: rgba(255,80,120,.55);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.38) inset,
        0 0 34px rgba(255,80,120,.13),
        0 0 58px rgba(255,80,120,.08);
      filter: saturate(1.10) brightness(1.02);
    }

    @media (max-width: 920px){
      .monthbar{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .monthbar{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topRow">
        <div class="title">2026 Calendar</div>
        <div class="rightRow">
          <button id="undoBtn" class="btnSubtle" type="button">Undo</button>
          <button id="imgBtn" class="btnSubtle" type="button">Add images</button>
          <button id="clearImgs" class="btnSubtle" type="button">Clear</button>
          <button id="wipeAll" class="btnDanger" type="button">Wipe all</button>
          <div id="status" class="status"></div>
        </div>
      </div>

      <div id="monthbar" class="monthbar"></div>

      <div class="calendar">
        <div id="monthTitle" class="monthTitle"></div>
        <div class="dow" id="dow"></div>
        <div class="grid" id="grid"></div>
      </div>

      <div class="composer">
        <textarea id="text" spellcheck="false" autocorrect="off" autocapitalize="off" autocomplete="off"></textarea>
        <div id="drop" class="drop"><div class="thumbs" id="thumbs"></div></div>
        <input id="file" type="file" accept="image/*" multiple />
      </div>
    </div>
  </div>

  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div>
          <h3 id="modalTitle" class="modalTitle"></h3>
          <div id="modalMeta" class="modalMeta"></div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="modalSave" class="btnSubtle" type="button" style="display:none;">Save</button>
          <button id="modalDelete" class="dangerBtn" type="button">Delete</button>
          <button id="modalClose" class="btnSubtle" type="button">Close</button>
        </div>
      </div>

      <div id="modalBody" class="modalBody"></div>

      <div id="modalForm" class="modalForm" style="display:none;">
        <input id="manualTitle" class="modalInput" type="text" />
        <textarea id="manualDetails" class="modalInput modalText" spellcheck="false" autocorrect="off" autocapitalize="off" autocomplete="off"></textarea>
      </div>
    </div>
  </div>

<script>
  const YEAR = 2026;
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const monthShort = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  const monthbarEl = document.getElementById("monthbar");
  const monthTitleEl = document.getElementById("monthTitle");
  const dowEl = document.getElementById("dow");
  const gridEl = document.getElementById("grid");

  const textEl = document.getElementById("text");
  const dropEl = document.getElementById("drop");
  const fileEl = document.getElementById("file");
  const thumbsEl = document.getElementById("thumbs");
  const imgBtn = document.getElementById("imgBtn");
  const clearImgsBtn = document.getElementById("clearImgs");
  const wipeAllBtn = document.getElementById("wipeAll");
  const undoBtn = document.getElementById("undoBtn");
  const statusEl = document.getElementById("status");

  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalMeta = document.getElementById("modalMeta");
  const modalBody = document.getElementById("modalBody");
  const modalClose = document.getElementById("modalClose");
  const modalDelete = document.getElementById("modalDelete");
  const modalSave = document.getElementById("modalSave");

  const modalForm = document.getElementById("modalForm");
  const manualTitleEl = document.getElementById("manualTitle");
  const manualDetailsEl = document.getElementById("manualDetails");

  let images = [];
  let selectedMonth = new Date().getFullYear() === YEAR ? new Date().getMonth() : 0;

  let activeEventId = null;

  let manualMode = false;
  let manualDate = null;
  let manualEditingId = null;

  /* ---------- UNDO (single-step) ---------- */
  const UNDO_KEY = "events_2026_undo";
  function snapshotForUndo() {
    // store a snapshot of the current events BEFORE a change
    try {
      const cur = localStorage.getItem("events_2026");
      localStorage.setItem(UNDO_KEY, cur ?? "[]");
    } catch {}
    updateUndoUI();
  }
  function canUndo() {
    const u = localStorage.getItem(UNDO_KEY);
    return u !== null;
  }
  function updateUndoUI() {
    undoBtn.disabled = !canUndo();
  }
  function doUndo() {
    const snap = localStorage.getItem(UNDO_KEY);
    if (snap === null) return;

    // restore snapshot into events_2026 and clear undo
    localStorage.setItem("events_2026", snap);
    localStorage.removeItem(UNDO_KEY);

    closeModal();
    renderMonth(selectedMonth);
    setStatus("Undone");
    updateUndoUI();
  }
  undoBtn.addEventListener("click", doUndo);

  function uid() {
    return "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function stableLegacyId(e) {
    const s = [
      e.date || "",
      e.title || "",
      e.details || "",
      e.all_day ? "1" : "0",
      e.start_time || "",
      e.end_time || ""
    ].join("|");
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) {
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "legacy_" + (h >>> 0).toString(16);
  }

  function migrateEvents(evts) {
    let changed = false;
    const out = (evts || []).map(e => {
      const ne = { ...e };
      if (!ne.id) { ne.id = stableLegacyId(ne); changed = true; }
      if (!ne.series_id) { ne.series_id = ne.id; changed = true; }
      if (!("source" in ne)) { ne.source = "ai"; changed = true; }
      return ne;
    });
    if (changed) localStorage.setItem("events_2026", JSON.stringify(out));
    return out;
  }

  function loadEvents() {
    try {
      const evts = JSON.parse(localStorage.getItem("events_2026") || "[]");
      return migrateEvents(evts);
    } catch { return []; }
  }
  function saveEvents(evts) { localStorage.setItem("events_2026", JSON.stringify(evts)); }

  function isoDate(y, m, d) {
    const mm = String(m + 1).padStart(2,"0");
    const dd = String(d).padStart(2,"0");
    return `${y}-${mm}-${dd}`;
  }
  function daysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }
  function isIsoDate(s) { return typeof s === "string" && /^\d{4}-\d{2}-\d{2}$/.test(s); }

  function setStatus(msg) { statusEl.textContent = msg || ""; }

  function normalizeEvents(apiEvents) {
    const out = [];
    for (const e of (apiEvents || [])) {
      const base = {
        id: uid(),
        series_id: uid(),
        source: "ai",
        title: String(e.title || "").trim() || "Untitled",
        details: String(e.details || "").trim(),
        all_day: !!e.all_day,
        start_time: e.start_time ?? null,
        end_time: e.end_time ?? null
      };

      const daysOfWeek = Array.isArray(e.days_of_week) ? e.days_of_week : null;

      if (isIsoDate(e.date)) {
        out.push({ ...base, date: e.date });
        continue;
      }

      if (isIsoDate(e.start_date) && isIsoDate(e.end_date)) {
        const start = new Date(e.start_date + "T00:00:00");
        const end = new Date(e.end_date + "T00:00:00");
        if (Number.isNaN(start.valueOf()) || Number.isNaN(end.valueOf()) || start > end) continue;

        const series = base.series_id;
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          if (daysOfWeek && daysOfWeek.length) {
            const wd = d.getDay();
            if (!daysOfWeek.includes(wd)) continue;
          }
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          out.push({ ...base, id: uid(), series_id: series, date: `${y}-${m}-${day}` });
        }
      }
    }
    return out;
  }

  function renderMonthBar() {
    monthbarEl.innerHTML = "";
    for (let i = 0; i < 12; i++) {
      const b = document.createElement("button");
      b.className = "mbtn" + (i === selectedMonth ? " active" : "");
      b.textContent = monthShort[i];
      b.addEventListener("click", () => {
        selectedMonth = i;
        renderMonthBar();
        renderMonth(selectedMonth);
      });
      monthbarEl.appendChild(b);
    }
  }

  function renderDow() {
    dowEl.innerHTML = "";
    for (const d of dows) {
      const el = document.createElement("div");
      el.textContent = d;
      dowEl.appendChild(el);
    }
  }

  function applyMonthFit(weeks) {
    const root = document.documentElement;
    if (weeks >= 6) {
      root.style.setProperty("--dayMinH", "68px");
      root.style.setProperty("--dayPad", "8px");
      root.style.setProperty("--dayGap", "6px");
      root.style.setProperty("--numSize", "11px");
      root.style.setProperty("--eventSize", "11px");
      root.style.setProperty("--eventPadY", "5px");
      root.style.setProperty("--eventPadX", "9px");
    } else if (weeks === 5) {
      root.style.setProperty("--dayMinH", "76px");
      root.style.setProperty("--dayPad", "9px");
      root.style.setProperty("--dayGap", "7px");
      root.style.setProperty("--numSize", "12px");
      root.style.setProperty("--eventSize", "11.5px");
      root.style.setProperty("--eventPadY", "6px");
      root.style.setProperty("--eventPadX", "10px");
    } else {
      root.style.setProperty("--dayMinH", "86px");
      root.style.setProperty("--dayPad", "10px");
      root.style.setProperty("--dayGap", "8px");
      root.style.setProperty("--numSize", "12px");
      root.style.setProperty("--eventSize", "12px");
      root.style.setProperty("--eventPadY", "6px");
      root.style.setProperty("--eventPadX", "10px");
    }
  }

  function openAiModal(eventObj) {
    manualMode = false;
    manualDate = null;
    manualEditingId = null;

    activeEventId = eventObj.id || null;

    const date = eventObj.date || "";
    const timeStr = eventObj.all_day
      ? "All day"
      : [eventObj.start_time, eventObj.end_time].filter(Boolean).join("–") || "";

    modalTitle.textContent = eventObj.title || "Event";
    modalMeta.textContent = timeStr ? `${date} • ${timeStr}` : `${date}`;

    modalBody.style.display = "";
    modalBody.textContent = (eventObj.details || "").trim() || "(no details)";

    modalForm.style.display = "none";
    modalSave.style.display = "none";

    modalDelete.disabled = !activeEventId;
    modalOverlay.classList.add("open");
    modalOverlay.setAttribute("aria-hidden", "false");
  }

  function openManualModal(dateKey) {
    manualMode = true;
    manualDate = dateKey;
    activeEventId = null;

    const evts = loadEvents();
    const existing = evts.find(e => e.source === "manual" && e.date === dateKey) || null;
    manualEditingId = existing?.id || null;

    modalTitle.textContent = dateKey;
    modalMeta.textContent = "";

    modalBody.style.display = "none";
    modalForm.style.display = "";
    modalSave.style.display = "";

    manualTitleEl.value = existing?.title || "";
    manualDetailsEl.value = existing?.details || "";

    modalDelete.disabled = !existing;
    modalOverlay.classList.add("open");
    modalOverlay.setAttribute("aria-hidden", "false");

    setTimeout(() => manualTitleEl.focus(), 0);
  }

  function closeModal() {
    modalOverlay.classList.remove("open");
    modalOverlay.setAttribute("aria-hidden", "true");
    activeEventId = null;
    manualMode = false;
    manualDate = null;
    manualEditingId = null;
  }

  function deleteActiveEvent() {
    const evts = loadEvents();

    // snapshot BEFORE delete
    snapshotForUndo();

    if (manualMode) {
      if (!manualDate) return;
      const next = evts.filter(e => !(e.source === "manual" && e.date === manualDate));
      saveEvents(next);
      closeModal();
      renderMonth(selectedMonth);
      setStatus("Deleted");
      return;
    }

    if (!activeEventId) return;
    const next = evts.filter(e => e.id !== activeEventId);
    saveEvents(next);
    closeModal();
    renderMonth(selectedMonth);
    setStatus("Deleted");
  }

  function saveManualEvent() {
    if (!manualDate) return;

    // snapshot BEFORE save/edit
    snapshotForUndo();

    const title = (manualTitleEl.value || "").trim();
    const details = (manualDetailsEl.value || "").trim();

    const evts = loadEvents();
    const next = evts.filter(e => !(e.source === "manual" && e.date === manualDate));

    if (!title && !details) {
      saveEvents(next);
      closeModal();
      renderMonth(selectedMonth);
      setStatus("Saved");
      return;
    }

    next.push({
      id: manualEditingId || uid(),
      series_id: manualEditingId || uid(),
      source: "manual",
      date: manualDate,
      title: title || "(note)",
      details,
      all_day: true,
      start_time: null,
      end_time: null
    });

    saveEvents(next);
    closeModal();
    renderMonth(selectedMonth);
    setStatus("Saved");
  }

  modalClose.addEventListener("click", closeModal);
  modalDelete.addEventListener("click", deleteActiveEvent);
  modalSave.addEventListener("click", saveManualEvent);
  modalOverlay.addEventListener("mousedown", (e) => { if (e.target === modalOverlay) closeModal(); });

  function renderMonth(m) {
    monthTitleEl.textContent = `${monthNames[m]} ${YEAR}`;
    gridEl.innerHTML = "";

    const evts = loadEvents();
    const firstDow = new Date(YEAR, m, 1).getDay();
    const dim = daysInMonth(YEAR, m);

    const totalCells = firstDow + dim;
    const weeks = Math.ceil(totalCells / 7);
    applyMonthFit(weeks);

    gridEl.style.gridTemplateRows = `repeat(${weeks}, minmax(0, 1fr))`;

    for (let i = 0; i < firstDow; i++) {
      const blank = document.createElement("div");
      blank.className = "day muted";
      gridEl.appendChild(blank);
    }

    for (let day = 1; day <= dim; day++) {
      const cell = document.createElement("div");
      cell.className = "day";
      const dateKey = isoDate(YEAR, m, day);

      cell.addEventListener("click", (ev) => {
        if (ev.target && ev.target.classList && ev.target.classList.contains("event")) return;
        openManualModal(dateKey);
      });

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = day;
      cell.appendChild(num);

      const todays = evts
        .filter(e => e.date === dateKey)
        .sort((a,b) => (a.source === "manual" ? -1 : 1));

      todays.slice(0, 3).forEach(e => {
        const pill = document.createElement("div");
        pill.className = "event";
        pill.title = (e.details || e.title || "").trim();
        pill.textContent = e.all_day ? e.title : `${e.start_time || ""} ${e.title}`.trim();

        pill.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (e.source === "manual") openManualModal(dateKey);
          else openAiModal(e);
        });

        cell.appendChild(pill);
      });

      if (todays.length > 3) {
        const more = document.createElement("div");
        more.className = "event more";
        more.textContent = `+${todays.length - 3}`;
        more.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const lines = todays.map(ev2 => {
            const timeStr = ev2.all_day ? "All day" : ([ev2.start_time, ev2.end_time].filter(Boolean).join("–") || "");
            const t = timeStr ? `${timeStr} — ${ev2.title}` : ev2.title;
            const d = (ev2.details || "").trim();
            return d ? `${t}\n${d}` : t;
          }).join("\n\n");

          openAiModal({ id: null, date: dateKey, title: `${dateKey}`, details: lines, all_day: true, start_time: null, end_time: null });
          modalDelete.disabled = true;
        });
        cell.appendChild(more);
      }

      gridEl.appendChild(cell);
    }
  }

  function refreshThumbs() {
    thumbsEl.innerHTML = "";
    images.forEach(img => {
      const el = document.createElement("img");
      el.src = URL.createObjectURL(img);
      el.className = "thumb";
      thumbsEl.appendChild(el);
    });
  }
  function addFiles(files) {
    for (const f of files) if (f.type && f.type.startsWith("image/")) images.push(f);
    refreshThumbs();
  }

  dropEl.addEventListener("dragover", (e) => { e.preventDefault(); });
  dropEl.addEventListener("drop", (e) => { e.preventDefault(); addFiles(e.dataTransfer.files); });

  imgBtn.addEventListener("click", () => fileEl.click());
  fileEl.addEventListener("change", () => addFiles(fileEl.files));

  clearImgsBtn.addEventListener("click", () => {
    images = [];
    fileEl.value = "";
    refreshThumbs();
  });

  wipeAllBtn.addEventListener("click", () => {
    // snapshot BEFORE wipe
    snapshotForUndo();

    localStorage.removeItem("events_2026");
    closeModal();
    renderMonth(selectedMonth);
    setStatus("Wiped");
  });

  function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }
  function prevMonth(){ selectedMonth = clamp(selectedMonth - 1, 0, 11); renderMonthBar(); renderMonth(selectedMonth); }
  function nextMonth(){ selectedMonth = clamp(selectedMonth + 1, 0, 11); renderMonthBar(); renderMonth(selectedMonth); }

  async function addToCalendar() {
    const text = textEl.value.trim();
    if (!text && images.length === 0) return;

    // snapshot BEFORE AI add
    snapshotForUndo();

    setStatus("…");

    const fd = new FormData();
    fd.append("text", text);
    images.forEach(img => fd.append("images", img));

    try {
      const resp = await fetch("/api/parse", { method: "POST", body: fd });
      const raw = await resp.text();
      let data;
      try { data = JSON.parse(raw); } catch { throw new Error("Server returned non-JSON"); }
      if (!resp.ok) throw new Error("Request failed");

      const normalized = normalizeEvents(data.events || []);
      if (normalized.length > 0) {
        const evts = loadEvents();
        evts.push(...normalized);
        saveEvents(evts);
        renderMonth(selectedMonth);
        setStatus(`+${normalized.length}`);
      } else {
        setStatus("0");
      }

      textEl.value = "";
      images = [];
      fileEl.value = "";
      refreshThumbs();
    } catch {
      // undo snapshot still exists; leave it so you can press Undo
      setStatus("Error");
    } finally {
      updateUndoUI();
    }
  }

  window.addEventListener("keydown", (e) => {
    if (modalOverlay.classList.contains("open")) {
      if (e.key === "Escape") { e.preventDefault(); closeModal(); return; }
      if ((e.key === "d" || e.key === "D")) { e.preventDefault(); deleteActiveEvent(); return; }
      if (manualMode && (e.key === "s" || e.key === "S") && (e.metaKey || e.ctrlKey)) {
        e.preventDefault(); saveManualEvent(); return;
      }
      if ((e.key === "u" || e.key === "U") && !e.metaKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault(); doUndo(); return;
      }
      return;
    }

    const el = document.activeElement;
    const tag = el?.tagName?.toLowerCase();
    const isTyping = tag === "textarea" || tag === "input";

    if (!isTyping && (e.key === "t" || e.key === "T")) { e.preventDefault(); textEl.focus(); return; }

    if (!isTyping) {
      if (e.key === "ArrowLeft") { e.preventDefault(); prevMonth(); return; }
      if (e.key === "ArrowRight") { e.preventDefault(); nextMonth(); return; }
      if ((e.key === "u" || e.key === "U") && !e.metaKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault(); doUndo(); return;
      }
    }

    // AI send: ONLY Alt/Option + Enter in textarea
    if (tag === "textarea" && e.key === "Enter") {
      if (e.altKey) { e.preventDefault(); addToCalendar(); return; }
      return;
    }
  });

  // init
  loadEvents();
  renderMonthBar();
  renderDow();
  renderMonth(selectedMonth);
  updateUndoUI();
</script>
</body>
</html>
